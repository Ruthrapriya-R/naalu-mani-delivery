<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart - Naalu Mani Delivery</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>
<header>
  <!-- Toast Notification -->
  <div id="addToast" class="toast"></div>
  <h1>Your Cart</h1>
</header>

<!-- Toast Notification -->
<div id="updateToast" class="toast"></div>


<main>
  {% if cart_items %}
    <table class="cart-table">
      <tr>
        <th>Item</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Subtotal</th>
      </tr>
      {% for item in cart_items %}
      <tr>
        <td>{{ item.name }}</td>
        <td>â‚¹{{ item.price }}</td>
        <td>
          <!-- âœ… Clean input, no + button -->
          <input type="number" class="quantity-input" data-id="{{ item.id }}" value="{{ item.quantity }}" min="1">
        </td>
        <td>â‚¹{{ item.price * item.quantity }}</td>
      </tr>
      {% endfor %}
      <tr>
        <th colspan="3">Total</th>
        <th id="total-price">â‚¹{{ total_price }}</th>
      </tr>
    </table>

    <div class="cart-actions">
      <a href="{{ url_for('payment') }}" class="btn btn-primary">Proceed to Payment</a>
      <a href="{{ url_for('clear_cart') }}" class="btn btn-danger">Clear Cart</a>
    </div>

  {% else %}
    <p class="center-text">Your cart is empty ðŸ›’</p>
    <a href="{{ url_for('home') }}" class="bottom-btn">Go Shopping</a>
  {% endif %}
</main>

<script>
  // ðŸ”” Show toast
  function showToast(message) {
    const toast = document.getElementById('updateToast');
    toast.innerText = message;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 2000);
  }

  // ðŸ§® Update totals in table
  function updateTotal() {
    let total = 0;
    let totalQty = 0;

    document.querySelectorAll('tr').forEach(row => {
      const priceCell = row.querySelector('td:nth-child(2)');
      const qtyInput = row.querySelector('.quantity-input');
      const subtotalCell = row.querySelector('td:nth-child(4)');

      if (priceCell && qtyInput && subtotalCell) {
        const price = parseFloat(priceCell.textContent.replace('â‚¹', '').trim()) || 0;
        const qty = parseInt(qtyInput.value) || 0;
        const subtotal = price * qty;
        subtotalCell.textContent = `â‚¹${subtotal}`;
        total += subtotal;
        totalQty += qty;
      }
    });

    // Update total in UI
    document.getElementById('total-price').textContent = `â‚¹${total}`;

    // Update header cart count if exists
    const countEl = document.getElementById('cart-count');
    if (countEl) countEl.textContent = totalQty;
  }

  // âš¡ Handle quantity change
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('change', () => {
      const itemId = input.dataset.id;
      const quantity = input.value;

      // Update backend
      fetch(`/update_cart/${itemId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: quantity })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateTotal();
          showToast("âœ… Cart updated!");
        }
      })
      .catch(error => console.error('Error:', error));
    });
  });
</script>


</body>
</html>
